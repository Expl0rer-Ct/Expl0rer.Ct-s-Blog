(()=>{var b={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","\u2026":"&hellip;"};function L(u){return b[u]||u}function v(u){return u.replace(/[&<>"]/g,L)}function E(u){return u.replace(/[.*+\-?^${}()|[\]\\]/g,"\\$&")}var x=class u{data;form;input;list;resultTitle;resultTitleTemplate;constructor({form:e,input:a,list:n,resultTitle:s,resultTitleTemplate:r}){this.form=e,this.input=a,this.list=n,this.resultTitle=s,this.resultTitleTemplate=r,this.input.value.trim()!==""?this.doSearch(this.input.value.split(" ")):this.handleQueryString(),this.bindQueryStringChange(),this.bindSearchForm()}static processMatches(e,a,n=!0,s=140,r=20,c,h){a.sort((l,t)=>l.start-t.start);let d=0,i=0,m=0,g=[];for(;d<a.length;){let l=a[d];n&&l.start-r>i?(g.push(`${v(e.substring(i,i+r))} [...] `),g.push(`${v(e.substring(l.start-r,l.start))}`),m+=r*2):(g.push(v(e.substring(i,l.start))),m+=l.start-i);let t=d+1,p=l.end;for(;t<a.length&&a[t].start<=p;)p=Math.max(a[t].end,p),++t;let f=`<mark>${v(e.substring(l.start,p))}</mark>`;if(h){let o=null;if(c&&c.length>0)for(let T=0;T<c.length;T++){let M=c[T],y=T+1<c.length?c[T+1]:null;if(l.start>=M.start&&(y===null||l.start<y.start)){o=M;break}}o&&(f=`<a href="${`${v(h)}#${encodeURIComponent(o.id)}`}" onclick="event.stopPropagation()">${f}</a>`)}if(g.push(f),m+=p-l.start,d=t,i=p,n&&m>s)break}if(i<e.length){let l=e.length;n&&(l=Math.min(l,i+r)),g.push(`${v(e.substring(i,l))}`),n&&l!=e.length&&g.push(" [...]")}return g.join("")}async searchKeywords(e){let a=await this.getData(),n=[],s=new RegExp(e.filter((r,c,h)=>(h[c]=E(r),r.trim()!=="")).join("|"),"gi");for(let r of a){let c=[],h=[],d=[],i={...r,preview:"",matchCount:0,headingMatches:[]},m=r.content.matchAll(s);for(let t of Array.from(m))h.push({start:t.index,end:t.index+t[0].length});let g=r.title.matchAll(s);for(let t of Array.from(g))c.push({start:t.index,end:t.index+t[0].length});for(let t of r.headings){let p=t.text.matchAll(s);if(Array.from(p).length>0){let w=[],f=t.text.matchAll(s);for(let o of Array.from(f))w.push({start:o.index,end:o.index+o[0].length});d.push({...t,text:u.processMatches(t.text,w,!1)})}}c.length>0&&(i.title=u.processMatches(i.title,c,!1));let l=[];if(Array.isArray(r.headings)){for(let t of r.headings)if(t.level===2||t.level===3){let p=t.text.split(/\s+/).map(f=>E(f)).filter(Boolean);if(p.length===0)continue;let w=p.join("\\s+");try{let o=new RegExp(w,"u").exec(r.content);o&&typeof o.index=="number"&&o.index>=0&&l.push({start:o.index,end:o.index+o[0].length,id:t.id,level:t.level})}catch{let o=r.content.indexOf(t.text);o>=0&&l.push({start:o,end:o+t.text.length,id:t.id,level:t.level})}}l.sort((t,p)=>t.start-p.start)}h.length>0?i.preview=u.processMatches(i.content,h,!0,140,20,l,r.permalink):i.preview=v(i.content.substring(0,140)),i.headingMatches=d,i.matchCount=c.length+h.length+d.length,i.matchCount>0&&n.push(i)}return n.sort((r,c)=>c.matchCount-r.matchCount)}async doSearch(e){let a=performance.now(),n=await this.searchKeywords(e);this.clear();for(let r of n)this.list.append(u.render(r));let s=performance.now();this.resultTitle.innerText=this.generateResultTitle(n.length,((s-a)/1e3).toPrecision(1))}generateResultTitle(e,a){return this.resultTitleTemplate.replace("#PAGES_COUNT",e).replace("#TIME_SECONDS",a)}async getData(){if(!this.data){let e=this.form.dataset.json;this.data=await fetch(e).then(n=>n.json());let a=new DOMParser;for(let n of this.data)n.content=a.parseFromString(n.content,"text/html").body.innerText}return this.data}bindSearchForm(){let e="",a=n=>{n.preventDefault();let s=this.input.value.trim();if(u.updateQueryString(s,!0),s==="")return e="",this.clear();e!==s&&(e=s,this.doSearch(s.split(" ")))};this.input.addEventListener("input",a),this.input.addEventListener("compositionend",a)}clear(){this.list.innerHTML="",this.resultTitle.innerText=""}bindQueryStringChange(){window.addEventListener("popstate",e=>{this.handleQueryString()})}handleQueryString(){let a=new URL(window.location.toString()).searchParams.get("keyword");this.input.value=a,a?this.doSearch(a.split(" ")):this.clear()}static updateQueryString(e,a=!1){let n=new URL(window.location.toString());e===""?n.searchParams.delete("keyword"):n.searchParams.set("keyword",e),a?window.history.replaceState("","",n.toString()):window.history.pushState("","",n.toString())}static render(e){let a=document.createElement("article"),n=document.createElement("a");n.href=e.permalink;let s=document.createElement("div");s.className="article-details";let r=document.createElement("h2");if(r.className="article-title",r.innerHTML=e.title,s.appendChild(r),e.headingMatches&&e.headingMatches.length>0){let h=document.createElement("div");h.className="article-headings",e.headingMatches.forEach(d=>{let i=document.createElement("div");i.className=`heading-match heading-level-${d.level}`;let m=document.createElement("a");m.href=`${e.permalink}#${d.id}`,m.innerHTML=d.text,m.addEventListener("click",g=>{g.stopPropagation()}),i.appendChild(m),h.appendChild(i)}),s.appendChild(h)}let c=document.createElement("section");if(c.className="article-preview",c.innerHTML=e.preview,s.appendChild(c),n.appendChild(s),e.image){let h=document.createElement("div");h.className="article-image";let d=document.createElement("img");d.src=e.image,d.loading="lazy",h.appendChild(d),n.appendChild(h)}return a.appendChild(n),a}};window.addEventListener("load",()=>{setTimeout(function(){let u=document.querySelector(".search-form"),e=u.querySelector("input"),a=document.querySelector(".search-result--list"),n=document.querySelector(".search-result--title");new x({form:u,input:e,list:a,resultTitle:n,resultTitleTemplate:window.searchResultTitleTemplate})},0)});var S=x;})();
