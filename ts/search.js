(()=>{var f={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","\u2026":"&hellip;"};function v(o){return f[o]||o}function g(o){return o.replace(/[&<>"]/g,v)}function w(o){return o.replace(/[.*+\-?^${}()|[\]\\]/g,"\\$&")}var m=class o{data;form;input;list;resultTitle;resultTitleTemplate;constructor({form:t,input:e,list:n,resultTitle:r,resultTitleTemplate:s}){this.form=t,this.input=e,this.list=n,this.resultTitle=r,this.resultTitleTemplate=s,this.input.value.trim()!==""?this.doSearch(this.input.value.split(" ")):this.handleQueryString(),this.bindQueryStringChange(),this.bindSearchForm()}static processMatches(t,e,n=!0,r=140,s=20){if(e.length===0)return g(t.substring(0,r));e.sort((l,u)=>l.start-u.start);let i=0,a=0,c=0,h=[];for(;i<e.length;){let l=e[i];n&&l.start-s>a?(h.push(`${g(t.substring(a,a+s))} [...] `),h.push(`${g(t.substring(l.start-s,l.start))}`),c+=s*2):(h.push(g(t.substring(a,l.start))),c+=l.start-a);let u=i+1,p=l.end;for(;u<e.length&&e[u].start<=p;)p=Math.max(e[u].end,p),u++;if(h.push(`<mark>${g(t.substring(l.start,p))}</mark>`),c+=p-l.start,i=u,a=p,n&&c>r)break}if(a<t.length){let l=t.length;n&&(l=Math.min(l,a+s)),h.push(g(t.substring(a,l))),n&&l!==t.length&&h.push(" [...]")}return h.join("")}async searchKeywords(t){let e=await this.getData(),n=[],r=t.filter(i=>i.trim()!=="").map(w);if(r.length===0)return[];let s=new RegExp(r.join("|"),"gi");for(let i of e){let a=[],c=[],h=i.title.matchAll(s);Array.from(h).forEach(d=>{d.index!==void 0&&a.push({start:d.index,end:d.index+d[0].length})});let l=i.content.matchAll(s);Array.from(l).forEach(d=>{d.index!==void 0&&c.push({start:d.index,end:d.index+d[0].length})});let u=a.length+c.length;if(u===0)continue;let p="";c.length>0?p=o.processMatches(i.content,c):p=g(i.content.substring(0,140));let T=a.length>0?o.processMatches(i.title,a,!1):i.title;n.push({...i,title:T,preview:p,matchCount:u})}return n.sort((i,a)=>a.matchCount-i.matchCount)}async doSearch(t){let e=performance.now(),n=await this.searchKeywords(t);this.clear(),n.forEach(i=>{this.list.appendChild(o.render(i))});let s=((performance.now()-e)/1e3).toPrecision(1);this.resultTitle.textContent=this.generateResultTitle(n.length,s)}generateResultTitle(t,e){return this.resultTitleTemplate.replace("#PAGES_COUNT",t.toString()).replace("#TIME_SECONDS",e)}async getData(){if(!this.data){let t=this.form.dataset.json;if(!t)throw new Error("\u672A\u8BBE\u7F6E\u641C\u7D22\u6570\u636EJSON URL");let e=await fetch(t);if(!e.ok)throw new Error(`\u83B7\u53D6\u6570\u636E\u5931\u8D25: ${e.statusText}`);let n=await e.json(),r=new DOMParser;this.data=n.map(s=>({...s,content:r.parseFromString(s.content,"text/html").body.innerText}))}return this.data}bindSearchForm(){let t="",e=n=>{n.preventDefault();let r=this.input.value.trim();if(o.updateQueryString(r,!0),r==="")return t="",this.clear();t!==r&&(t=r,this.doSearch(r.split(" ")))};this.input.addEventListener("input",e),this.input.addEventListener("compositionend",e),this.form.addEventListener("submit",e)}clear(){this.list.innerHTML="",this.resultTitle.textContent=""}bindQueryStringChange(){window.addEventListener("popstate",()=>{this.handleQueryString()})}handleQueryString(){let e=new URL(window.location.href).searchParams.get("keyword")||"";this.input.value=e,e?this.doSearch(e.split(" ")):this.clear()}static updateQueryString(t,e=!1){let n=new URL(window.location.href);t===""?n.searchParams.delete("keyword"):n.searchParams.set("keyword",t);let r=e?"replaceState":"pushState";window.history[r]("","",n.toString())}static render(t){let e=document.createElement("article"),n=document.createElement("a");n.href=t.permalink;let r=document.createElement("div");r.className="article-details";let s=document.createElement("h2");s.className="article-title",s.innerHTML=t.title,r.appendChild(s);let i=document.createElement("section");if(i.className="article-preview",i.innerHTML=t.preview,r.appendChild(i),n.appendChild(r),t.image){let a=document.createElement("div");a.className="article-image";let c=document.createElement("img");c.src=t.image,c.loading="lazy",a.appendChild(c),n.appendChild(a)}return e.appendChild(n),e}};function E(){let o=document.querySelector(".search-form"),t=o?.querySelector("input"),e=document.querySelector(".search-result--list"),n=document.querySelector(".search-result--title");o&&t&&e&&n?new m({form:o,input:t,list:e,resultTitle:n,resultTitleTemplate:window.searchResultTitleTemplate||"\u627E\u5230 #PAGES_COUNT \u4E2A\u7ED3\u679C\uFF08\u8017\u65F6 #TIME_SECONDS \u79D2\uFF09"}):console.warn("\u641C\u7D22\u76F8\u5173DOM\u5143\u7D20\u672A\u627E\u5230\uFF0C\u65E0\u6CD5\u521D\u59CB\u5316\u641C\u7D22\u529F\u80FD")}setTimeout(E,0);var y=m;})();
